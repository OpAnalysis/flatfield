<!doctype html>
<html>

<head>

    <meta charset="utf-8">
    <title>Pin the Flat Field</title>

    <!-- Import Leaflet CSS library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>

    <!-- Legend CSS -->
    <style type="text/css">
        .legend {
            padding: 0px 4px;
            font: 12px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255, 255, 255, 0.7);
            /*box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);*/
            /*border-radius: 5px;*/
            line-height: 14px;
            color: #555;
        }
    
        .legend heading {
            position: relative;
            text-align: center;
            font-weight: bold;
            bottom: 2px;
        }

        .legend span {
            position: relative;
            font-weight: bold;
            bottom: 2px;
        }
    
        .legend i {
            width: 18px;
            height: 11px;
            outline:solid black 1px;
            float: left;
            margin: 0px 4px 0 0;
            opacity: 0.7;
        }
    
    </style>

    <!-- Custom CSS  -->
    <style type="text/css">
        html, body { width: 100%; height: 100%; margin: 0; }
        #map1, #map2 { width: 49.7%; height: 100%; }
        #map1 { float: left; }
        #map2 { float: right; }
    </style>
    
</head>

<body>

    <!--------------------------------------------------
                IMPORT JAVASCRIPT AND PLUGINS
    --------------------------------------------------->

    <!-- Import Leaflet JavaScript library -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
    
    <!-- Import Leaflet.Sync plugin -->
    <script src="L.Map.Sync.js"></script>


    <!--------------------------------------------------
                  CREATE DIVS FOR MAP PANELS
    --------------------------------------------------->

    <div id="map1"></div>
    <div id="map2"></div>
 

    <!--------------------------------------------------
                      MAIN JAVASCRIPT
    --------------------------------------------------->

    <script type="text/javascript">


        /*================================================
                        BASE MAP DEFINITIONS
         =================================================*/

        // Greyscale base map 1
        var grey1 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                      	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                      	subdomains: 'abcd',
                     	maxZoom: 20
                    });

        // Greyscale base map 2
        var grey2 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                      	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                      	subdomains: 'abcd',
                     	maxZoom: 20
                    });

        // Open Street Map base map 1
        var osm1 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                    })
 
        // Open Street Map base map 2
        var osm2 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                    })
 
        // Google satellite base map 1
        var satellite1 = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
                        maxZoom: 20,
                        subdomains:['mt0','mt1','mt2','mt3']
                    });

        // Google satellite base map 2
        var satellite2 = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
                        maxZoom: 20,
                        subdomains:['mt0','mt1','mt2','mt3']
                    });


        /*================================================
                        OVERLAY DEFINITIONS
         =================================================*/
     
        // Satellite cloud observation (GOES-East Day Visibility) from MSC GeoMet (GeoMet-Weather)
        var geometGOES_EastDayVisibility = L.tileLayer.wms("https://geo.weather.gc.ca/geomet", {
            layers: 'GOES-East_1km_DayVis',
            version: '1.3.0',
            format: 'image/png',
            transparent: true,
            opacity: 0.5,
            attribution: 'MSC GeoMet'
        });

        // North American composite weather radar (rain rate [mm/h]) from MSC GeoMet (GeoMet-Weather)
        var geometWeatherRadarRainRate = L.tileLayer.wms("https://geo.weather.gc.ca/geomet", {
            layers: 'RADAR_1KM_RRAI',
            version: '1.3.0',
            format: 'image/png',
            transparent: true,
            opacity: 0.5,
            attribution: 'MSC GeoMet'
        });

        // North American composite weather radar (snow rate [cm/h]) from MSC GeoMet (GeoMet-Weather)
        var geometWeatherRadarSnowRate = L.tileLayer.wms("https://geo.weather.gc.ca/geomet", {
            layers: 'RADAR_1KM_RSNO',
            version: '1.3.0',
            format: 'image/png',
            transparent: true,
            opacity: 0.5,
            attribution: 'MSC GeoMet'
        });

        // US weather radar from Nexrad
        var nexradWeatherRadar = L.tileLayer.wms("http://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi", {
            layers: 'nexrad-n0r-900913',
            format: 'image/png',
            transparent: true,
            attribution: "Weather data Â© 2012 IEM Nexrad"
        });

        // Canada Lightning Danger Map from MSC GeoMet (GeoMet-Weather)
        var geometCanadaLightningDanger = L.tileLayer.wms("https://geo.weather.gc.ca/geomet", {
            layers: 'Lightning_2.5km_Density',
            version: '1.3.0',
            format: 'image/png',
            transparent: true,
            opacity: 0.5,
            attribution: 'MSC GeoMet'
        });

        // Canadian accumulated precipitation in last 24 hours at local noon from CWFIS
        var precipitationLast24Hours = L.tileLayer.wms("https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms?service=WMS", {
            layers: 'precip_current',
            format: 'image/png',
            transparent: true,
            opacity: 0.5,
            attribution: 'CWFIS',
        });

        // Canadian relative humidity at local noon from CWFIS
        var relativeHumidityAtNoon = L.tileLayer.wms("https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms?service=WMS", {
            layers: 'rh_current',
            format: 'image/png',
            transparent: true,
            opacity: 0.5,
            attribution: 'CWFIS',
        });

        // Canadian temperature at local noon from CWFIS
        var temperatureAtNoon = L.tileLayer.wms("https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms?service=WMS", {
            layers: 'temp_current',
            format: 'image/png',
            transparent: true,
            opacity: 0.5,
            attribution: 'CWFIS',
        });

        // Canadian weather alerts from MSC GeoMet (GeoMet-Weather)
        var weatherAlerts = L.tileLayer.wms("https://geo.weather.gc.ca/geomet/?lang=en&version=1.3.0", {
            layers: 'ALERTS',
            format: 'image/png',
            transparent: true,
            opacity: 0.5,
            attribution: 'MSC GeoMet',
        });

        // Canadian wind direction at local noon from CWFIS
        var windDirectionAtNoon = L.tileLayer.wms("https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms?service=WMS", {
            layers: 'wdir_current',
            format: 'image/png',
            transparent: true,
            opacity: 0.5,
            attribution: 'CWFIS',
        });

        // Canadian wind speed at local noon from CWFIS
        var windSpeedAtNoon = L.tileLayer.wms("https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms?service=WMS", {
            layers: 'ws_current',
            format: 'image/png',
            transparent: true,
            opacity: 0.5,
            attribution: 'CWFIS',
        });

        // Canadian active wildfires status from CWFIS
        var activeFiresStatus = L.tileLayer.wms("https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms?service=WMS", {
            layers: 'activefires_current',
            format: 'image/png',
            transparent: true,
            opacity: 0.5,
            attribution: 'CWFIS',
        });

        // Canadian active wildfire perimeters from CWFIS
        var activeFirePerimeters = L.tileLayer.wms("https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms?service=WMS", {
            layers: 'm3_polygons_current',
            format: 'image/png',
            transparent: true,
            opacity: 0.5,
            attribution: 'CWFIS',
        });

        // Canadian current fire danger from CWFIS
        var currentFireDanger = L.tileLayer.wms("https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms?service=WMS", {
            layers: 'fdr_current',
            format: 'image/png',
            transparent: true,
            opacity: 0.5,
            attribution: 'CWFIS',
        });

        // Canadian current fire weather index from CWFIS
        var currentFireWeatherIndex = L.tileLayer.wms("https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms?service=WMS", {
            layers: 'fwi_current',
            format: 'image/png',
            transparent: true,
            opacity: 0.5,
            attribution: 'CWFIS',
        });

        // Canadian current head fire intensity from CWFIS
        var currentHeadFireIntensity = L.tileLayer.wms("https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms?service=WMS", {
            layers: 'hfi_current',
            format: 'image/png',
            transparent: true,
            opacity: 0.5,
            attribution: 'CWFIS',
        });

        // Canadian current fire rate of spread from CWFIS
        var currentFireRateOfSpread = L.tileLayer.wms("https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms?service=WMS", {
            layers: 'ros_current',
            format: 'image/png',
            transparent: true,
            opacity: 0.5,
            attribution: 'CWFIS',
        });

        /*================================================
                        LEGEND DEFINITIONS
         =================================================*/

        /* Legend for Alerts overlay */
        var legendAlerts = L.control({ position: "topright" });
        legendAlerts.onAdd = function(map1) {
            var div = L.DomUtil.create("div", "legend");
            div.innerHTML += '<heading>Alerts</heading><br>';
//            div.innerHTML += "<img src=\"https://geo.weather.gc.ca/geomet?version=1.3.0&service=WMS&request=GetLegendGraphic&sld_version=1.1.0&layer=ALERTS&format=image/png&STYLE=ALERTS&\">";
            div.innerHTML += '<i style="background: #FF0000"></i><span>warning</span><br>';
            div.innerHTML += '<i style="background: #FFFF00"></i><span>watch</span><br>';
            div.innerHTML += '<i style="background: #7D7F7C"></i><span>statement</span><br>';
            div.innerHTML += '<i style="background: #7D7F7C"></i><span>advisory</span><br>';
            return div;
        };

        /* Legend for Active fires (areas) overlay */
        var legendActiveFiresAreas = L.control({ position: "topright" });
        legendActiveFiresAreas.onAdd = function(map2) {
            var div = L.DomUtil.create("div", "legend");
            div.innerHTML += '<heading>Active fires (areas)</heading><br>';
//            div.innerHTML += "<img src=\"https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms?request=GetLegendGraphic&version=1.1.1&format=image/png&width=20&height=20&layer=activefires_current&\">";
            div.innerHTML += '<i style="background: #ff9c99"></i><span>active fire area</span><br>';
            return div;
        };

        /* Legend for Active fires (status) overlay */
        var legendActiveFiresStatus = L.control({ position: "topright" });
        legendActiveFiresStatus.onAdd = function(map2) {
            var div = L.DomUtil.create("div", "legend");
            div.innerHTML += '<heading>Active fires (status)</heading><br>';
//            div.innerHTML += "<img src=\"https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms?request=GetLegendGraphic&version=1.1.1&format=image/png&width=20&height=20&layer=activefires_current&\">";
            div.innerHTML += '<i style="background: #FF0000"></i><span>out of control</span><br>';
            div.innerHTML += '<i style="background: #FFFF00"></i><span>being held</span><br>';
            div.innerHTML += '<i style="background: #6699FF"></i><span>under control</span><br>';
            return div;
        };

        /* Legend for Fire danger overlay */
        var legendFireDanger = L.control({ position: "topright" });
        legendFireDanger.onAdd = function(map2) {
            var div = L.DomUtil.create("div", "legend");
            div.innerHTML += '<heading>Fire danger</heading><br>';
//            div.innerHTML += "<img src=\"https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms?request=GetLegendGraphic&version=1.1.1&format=image/png&width=20&height=20&layer=fdr_current_shp&\">";
            div.innerHTML += '<i style="background: #FF0000"></i><span>extreme</span><br>';
            div.innerHTML += '<i style="background: #8d7028"></i><span>very high</span><br>';
            div.innerHTML += '<i style="background: #FFFF00"></i><span>high</span><br>';
            div.innerHTML += '<i style="background: #00e000"></i><span>moderate</span><br>';
            div.innerHTML += '<i style="background: #0000FF"></i><span>low</span><br>';
            return div;
        };

        /* Legend for Fire rate of spread overlay */
        var legendFireRateOfSpread = L.control({ position: "topright" });
        legendFireRateOfSpread.onAdd = function(map2) {
            var div = L.DomUtil.create("div", "legend");
            div.innerHTML += '<heading>Fire rate of spread</heading><br>';
//            div.innerHTML += "<img src=\"https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms?request=GetLegendGraphic&version=1.1.1&format=image/png&width=20&height=20&layer=fdr_current_shp&\">";
            div.innerHTML += '<i style="background: #FF0000"></i><span>>25 m/min</span><br>';
            div.innerHTML += '<i style="background: #8d7028"></i><span>18-25 m/min</span><br>';
            div.innerHTML += '<i style="background: #FFFF00"></i><span>10-18 m/min</span><br>';
            div.innerHTML += '<i style="background: #00e000"></i><span>3-10 m/min</span><br>';
            div.innerHTML += '<i style="background: #2d8e2d"></i><span>1-3 m/min</span><br>';
            div.innerHTML += '<i style="background: #0000FF"></i><span>0-1 m/min</span><br>';
            return div;
        };

        /* Legend for Fire weather index overlay */
        var legendFireWeatherIndex = L.control({ position: "topright" });
        legendFireWeatherIndex.onAdd = function(map2) {
            var div = L.DomUtil.create("div", "legend");
            div.innerHTML += '<heading>Fire weather index</heading><br>';
//            div.innerHTML += "<img src=\"https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms?request=GetLegendGraphic&version=1.1.1&format=image%2Fpng&width=20&height=20&layer=fwi\">";
            div.innerHTML += '<i style="background: #FF0000"></i><span>>30</span><br>';
            div.innerHTML += '<i style="background: #8d7028"></i><span>20-30</span><br>';
            div.innerHTML += '<i style="background: #FFFF00"></i><span>10-20</span><br>';
            div.innerHTML += '<i style="background: #00e000"></i><span>5-10</span><br>';
            div.innerHTML += '<i style="background: #0000FF"></i><span>0-5</span><br>';
            return div;
        };

        /* Legend for Head fire intensity overlay */
        var legendHeadFireIntensity = L.control({ position: "topright" });
        legendHeadFireIntensity.onAdd = function(map2) {
            var div = L.DomUtil.create("div", "legend");
            div.innerHTML += '<heading>Head fire intensity</heading><br>';
//            div.innerHTML += "<img src=\"https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms?request=GetLegendGraphic&version=1.1.1&format=image/png&width=20&height=20&layer=hfi_current&\">";
            div.innerHTML += '<i style="background: #FF0000"></i><span>>30000 kW/m</span><br>';
            div.innerHTML += '<i style="background: #8d7028"></i><span>10000-30000 kW/m</span><br>';
            div.innerHTML += '<i style="background: #FFFF00"></i><span>4000-10000 kW/m</span><br>';
            div.innerHTML += '<i style="background: #00e000"></i><span>2000-4000 kW/m</span><br>';
            div.innerHTML += '<i style="background: #2d8e2d"></i><span>500-2000 kW/m</span><br>';
            div.innerHTML += '<i style="background: #00c0c0"></i><span>10-500 kW/m</span><br>';
            div.innerHTML += '<i style="background: #0000FF"></i><span>0-10 kW/m/span><br>';
            return div;
        };


        /*================================================
                            MARKERS
         =================================================*/

//        var singleMarker = L.marker([initialMapLat, initialMapLng]);
//        var popup = singleMarker.bindPopup('This is an example of a popup.').openPopup()
//        popup.addTo(map);


        /*================================================
                           MAP PANELS
         =================================================*/

        // Initial parameters for map panels
        var initialMapLat = 54;     // iniital latitude
        var initialMapLng = -98;    // initial longitude
        var initialMapZoom = 3;     // initial zoom level
        var initialMapCentre = [initialMapLat, initialMapLng];
        var minPanelZoom = 3

        // Set default base maps
        var defaultBaseMap1 = grey1;
        var defaultBaseMap2 = osm2;

        // Define map panel 1
        var map1 = L.map('map1', {
            layers: [defaultBaseMap1],
            center: initialMapCentre,
            zoom: initialMapZoom,
            minZoom: minPanelZoom
        });

        // Define map panel 2
        var map2 = L.map('map2', {
            layers: [defaultBaseMap2],
            center: initialMapCentre,
            zoom: initialMapZoom,
            zoomControl: false,
            minZoom: minPanelZoom
        });


        /*================================================
                        LAYER CONTROLLERS
         =================================================*/

        // List base maps to include in layer controller 1
        var baseLayers1 = {
            "Greyscale": grey1,
            "Satellite": satellite1,
            "Street": osm1
        };

        // List base maps to include in layer controller 2
        var baseLayers2 = {
            "Greyscale": grey2,
            "Satellite": satellite2,
            "Street": osm2
        };

        // List overlays to include in layer controller 1
        var overlayLayers1 = {
//            "Marker": singleMarker,
            "Alerts": weatherAlerts,
            "Cloud cover (daytime)": geometGOES_EastDayVisibility,
            "Lightning (last 10 min)": geometCanadaLightningDanger,
            "Precipitation (last 24 h)": precipitationLast24Hours,
            "Radar (rain rate)": geometWeatherRadarRainRate,
            "Relative humidity (noon)": relativeHumidityAtNoon,
            "Temperature (noon)": temperatureAtNoon,
            "Wind direction (noon)": windDirectionAtNoon,
            "Wind speed (noon)": windSpeedAtNoon
        };

        // List overlays to include in layer controller 2
        var overlayLayers2 = {
            "Active fires (areas)": activeFirePerimeters,
            "Active fires (status)": activeFiresStatus,
            "Fire danger": currentFireDanger,
            "Fire rate of spread": currentFireRateOfSpread,
            "Fire weather index": currentFireWeatherIndex,
            "Head fire intensity": currentHeadFireIntensity
        };

        // Add modified layer controllers to maps
        var layerControl1 = L.control.layers(baseLayers1, overlayLayers1, { collapsed: true }).addTo(map1);
        var layerControl2 = L.control.layers(baseLayers2, overlayLayers2, { collapsed: true }).addTo(map2);


        /*================================================
                        MAP SYNCHRONIZATION
         =================================================*/

        map1.sync(map2);
        map2.sync(map1);


        /*================================================
                        OVERLAY EVENTS
         =================================================*/

        // MAP 1 //
        
            // Show legend when its associated overlay is added
            map1.on('overlayadd', function(eventLayer){
                if (eventLayer.name === 'Alerts'){
                    legendAlerts.addTo(map1);
                } 
            });

            // Remove legend when its associated overlay is removed
            map1.on('overlayremove', function(eventLayer){
                if (eventLayer.name === 'Alerts'){
                    legendAlerts.remove(map1);
                }
            }); 


        // MAP 2 // 
        
            // Show legend when its associated overlay is added
            map2.on('overlayadd', function(eventLayer){
                if (eventLayer.name === 'Active fires (areas)'){
                    legendActiveFiresAreas.addTo(map2);
                } else if (eventLayer.name === 'Active fires (status)'){
                    legendActiveFiresStatus.addTo(map2);
                } else if (eventLayer.name === 'Fire danger'){
                    legendFireDanger.addTo(map2);
                } else if (eventLayer.name === 'Fire rate of spread'){
                    legendFireRateOfSpread.addTo(map2);
                } else if (eventLayer.name === 'Fire weather index'){
                    legendFireWeatherIndex.addTo(map2);
                } else if (eventLayer.name === 'Head fire intensity'){
                    legendHeadFireIntensity.addTo(map2);
                } 
            });

            // Remove legend when its associated overlay is removed
            map2.on('overlayremove', function(eventLayer){
                if (eventLayer.name === 'Active fires (areas)'){
                    legendActiveFiresAreas.remove(map2);
                } else if (eventLayer.name === 'Active fires (status)'){
                    legendActiveFiresStatus.remove(map2);
                } else if (eventLayer.name === 'Fire danger'){
                    legendFireDanger.remove(map2);
                } else if (eventLayer.name === 'Fire rate of spread'){
                    legendFireRateOfSpread.remove(map2);
                } else if (eventLayer.name === 'Fire weather index'){
                    legendFireWeatherIndex.remove(map2);
                } else if (eventLayer.name === 'Head fire intensity'){
                    legendHeadFireIntensity.remove(map2);
                }
            }); 


        /*================================================
                        ACTIVATE INITIAL OVERLAYS
         =================================================*/

        // Map 1 initial overlays
        weatherAlerts.addTo(map1)
    
        // Map 2 initial overlays
        activeFirePerimeters.addTo(map2)
        activeFiresStatus.addTo(map2)


    </script>
</body>
</html>
